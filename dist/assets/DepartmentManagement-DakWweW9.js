import{r as d,h as le,z as A,B as u,R as n,J as r,al as c,ar as oe,A as k,K as ne,ah as te,O as y,I as R,P as re,Q as se,a5 as ie}from"./vendor-DdeEpjzh.js";import{a as h}from"./index-ID-G45V4.js";import{_ as de}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{E as p,a as ue,b as me}from"./element-DkRX-ly5.js";const ce={class:"department-management"},pe={class:"card-header"},ge={class:"search-bar"},ve={class:"employee-count"},fe={class:"pagination"},ye={class:"dialog-footer"},_e={__name:"DepartmentManagement",setup(he){const b=d(""),C=d(1),x=d(10),L=d(0),M=d(!1),S=d(!1),I=d([]),v=d([]),N=d(!1),z=d(""),_=d(!1),w=d(null),s=d({id:null,departmentName:"",managerId:null,managerName:"",employeeCount:0,description:""}),m=d(null),T={departmentName:[{required:!0,message:"请输入部门名称",trigger:"blur"},{min:1,max:50,message:"部门名称长度在 1 到 50 个字符",trigger:"blur"}],description:[{max:200,message:"部门描述长度不能超过 200 个字符",trigger:"blur"}]},f=async()=>{M.value=!0;try{const l=await h.admin.getDeptList();if(l&&(l.code===1||l.code===200)){let e=l.data||[];Array.isArray(e)||e.list&&(e=e.list),b.value&&(e=e.filter(i=>i.departmentName&&i.departmentName.includes(b.value)));const a=(C.value-1)*x.value,o=a+x.value;I.value=e.slice(a,o),L.value=e.length,console.log("部门数据加载成功:",I.value)}else console.error("加载部门数据失败，响应状态码:",l?.code),p.error(l?.msg||"加载数据失败")}catch(l){console.error("加载部门数据失败",l),p.error("网络错误，请稍后重试")}finally{M.value=!1}},U=()=>{C.value=1,f()},F=()=>{b.value="",C.value=1,f()},B=async(l="")=>{try{const e=await h.admin.getDynamicEmployees(l);if(console.log("从动态员工API获取的部门经理列表响应:",e),e&&(e.code===1||e.code===200)&&e.data){const a=Object.entries(e.data).map(([o,i])=>({id:i,name:o}));console.log("处理后的部门经理列表:",a),v.value=a}else console.warn("获取部门经理列表失败，响应:",e),v.value=[{id:1,name:"张三",position:"经理"},{id:2,name:"李四",position:"副经理"},{id:3,name:"王五",position:"主管"},{id:"4",name:"陈护士",position:"护士"}]}catch(e){console.error("加载部门经理列表失败",e),v.value=[{id:1,name:"张三",position:"经理"},{id:2,name:"李四",position:"副经理"},{id:3,name:"王五",position:"主管"},{id:"4",name:"陈护士",position:"护士"}]}},K=async l=>{S.value=!0;try{await B(l)}finally{S.value=!1}},P=l=>{console.log("部门经理选择变化:",l),l?(s.value.managerId=l.id,s.value.managerName=l.name):(s.value.managerId=null,s.value.managerName="")},j=async()=>{_.value=!1,z.value="添加部门",$(),await B(""),N.value=!0},O=async l=>{_.value=!0,z.value="编辑部门",$();const e=ue.service({lock:!0,text:"加载中...",background:"rgba(0, 0, 0, 0.7)"});try{await B();const a=await h.admin.findDeptById(l.id);if(a&&(a.code===1||a.code===200)){const o=a.data;if(console.log("获取的部门详情:",o),console.log("可用的部门经理列表:",v.value),s.value={id:o.id,departmentName:o.departmentName,managerId:o.managerId,managerName:o.managerName||"",employeeCount:o.employeeCount||0,description:o.description||"",selectedManager:null},o.managerId){const i=String(o.managerId);console.log(`尝试匹配部门经理，目标ID: ${i}, 目标名称: ${o.managerName}`);let D=v.value.find(g=>String(g.id)===i);if(!D&&o.managerName&&(console.log(`尝试通过名称匹配部门经理: ${o.managerName}`),D=v.value.find(g=>g.name===o.managerName)),m.value=D||null,m.value)console.log(`成功匹配部门经理: ${m.value.name}`),s.value.managerId=m.value.id,s.value.managerName=m.value.name;else if(console.log(`找不到ID为${o.managerId}或名称为${o.managerName}的部门经理`),m.value=null,s.value.managerId=o.managerId,s.value.managerName=o.managerName||"",o.managerName){const g={id:o.managerId,name:o.managerName};v.value.push(g),m.value=g,console.log("创建并使用临时部门经理对象:",g)}}else console.log("该部门没有指定部门经理"),m.value=null;N.value=!0}else p.error(a?.msg||"获取部门详情失败")}catch(a){console.error("获取部门详情失败",a),p.error("获取部门详情失败，请稍后重试")}finally{e.close()}},Q=l=>{const e=I.value.find(a=>a.id===l);if(e&&e.employeeCount>0){p.warning("该部门下还有员工，无法删除");return}me.confirm("确定要删除该部门吗？删除后数据将无法恢复！","警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const a=await h.admin.deleteDept(l);a&&(a.code===1||a.code===200)?(p.success("删除成功"),f()):p.error(a?.msg||"删除失败")}catch(a){console.error("删除部门失败",a),p.error("删除失败，请稍后重试")}}).catch(()=>{})},q=l=>{x.value=l,f()},J=l=>{C.value=l,f()},W=async()=>{w.value&&await w.value.validate(async l=>{if(l)try{let e;_.value?e=await h.admin.updateDept(s.value):e=await h.admin.addDept(s.value),e&&(e.code===1||e.code===200)?(p.success(_.value?"更新成功":"添加成功"),E(),f()):p.error(e?.msg||(_.value?"更新失败":"添加失败"))}catch(e){console.error(_.value?"更新部门失败":"添加部门失败",e),p.error("网络错误，请稍后重试")}})},E=()=>{$(),N.value=!1},$=()=>{s.value={id:null,departmentName:"",managerId:null,managerName:"",employeeCount:0,description:""},m.value=null,w.value&&w.value.resetFields()};return le(()=>{f()}),(l,e)=>{const a=c("el-button"),o=c("el-input"),i=c("el-table-column"),D=c("el-table"),g=c("el-pagination"),G=c("el-card"),V=c("el-form-item"),H=c("el-option"),X=c("el-select"),Y=c("el-form"),Z=c("el-dialog"),ee=oe("loading");return k(),A("div",ce,[e[14]||(e[14]=u("div",{class:"page-header"},[u("h2",null,"部门信息管理"),u("p",null,"管理系统中的所有部门信息")],-1)),n(G,{class:"content-card shadow-card"},{header:r(()=>[u("div",pe,[e[7]||(e[7]=u("span",null,"部门列表",-1)),n(a,{type:"primary",onClick:j,plain:""},{default:r(()=>[...e[6]||(e[6]=[u("i",{class:"el-icon-plus"},null,-1),y(" 添加部门 ",-1)])]),_:1})])]),default:r(()=>[u("div",ge,[n(o,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=t=>b.value=t),placeholder:"搜索部门名称","prefix-icon":"el-icon-search",style:{width:"300px"},onKeyup:te(U,["enter"])},null,8,["modelValue"]),n(a,{type:"primary",onClick:U},{default:r(()=>[...e[8]||(e[8]=[u("i",{class:"el-icon-search"},null,-1),y(" 搜索 ",-1)])]),_:1}),n(a,{onClick:F},{default:r(()=>[...e[9]||(e[9]=[u("i",{class:"el-icon-refresh"},null,-1),y(" 重置 ",-1)])]),_:1})]),ne((k(),R(D,{data:I.value,style:{width:"100%"},"header-cell-style":{backgroundColor:"#f7f9fc",fontWeight:"bold"},"row-class-name":"department-row"},{default:r(()=>[n(i,{prop:"id",label:"部门ID",width:"80"}),n(i,{prop:"departmentName",label:"部门名称"}),n(i,{prop:"managerName",label:"部门经理"}),n(i,{prop:"employeeCount",label:"员工人数",width:"120"},{default:r(t=>[u("span",ve,re(t.row.employeeCount),1)]),_:1}),n(i,{prop:"description",label:"部门描述"}),n(i,{label:"操作",width:"150",fixed:"right"},{default:r(t=>[n(a,{size:"small",onClick:ae=>O(t.row),type:"primary",plain:""},{default:r(()=>[...e[10]||(e[10]=[y(" 编辑 ",-1)])]),_:1},8,["onClick"]),n(a,{size:"small",type:"danger",onClick:ae=>Q(t.row.id)},{default:r(()=>[...e[11]||(e[11]=[y(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ee,M.value]]),u("div",fe,[n(g,{"current-page":C.value,"page-size":x.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:L.value,onSizeChange:q,onCurrentChange:J},null,8,["current-page","page-size","total"])])]),_:1}),n(Z,{modelValue:N.value,"onUpdate:modelValue":e[5]||(e[5]=t=>N.value=t),title:z.value,width:"500px","before-close":E},{footer:r(()=>[u("span",ye,[n(a,{onClick:E},{default:r(()=>[...e[12]||(e[12]=[y("取消",-1)])]),_:1}),n(a,{type:"primary",onClick:W},{default:r(()=>[...e[13]||(e[13]=[y("确定",-1)])]),_:1})])]),default:r(()=>[n(Y,{model:s.value,rules:T,ref_key:"formRef",ref:w,"label-width":"100px"},{default:r(()=>[n(V,{label:"部门名称",prop:"departmentName"},{default:r(()=>[n(o,{modelValue:s.value.departmentName,"onUpdate:modelValue":e[1]||(e[1]=t=>s.value.departmentName=t),placeholder:"请输入部门名称",maxlength:"50"},null,8,["modelValue"])]),_:1}),n(V,{label:"部门经理"},{default:r(()=>[n(X,{modelValue:m.value,"onUpdate:modelValue":e[2]||(e[2]=t=>m.value=t),placeholder:"请输入并选择部门经理",clearable:"",filterable:"",remote:"","remote-method":K,loading:S.value,onChange:P,"value-key":"id"},{default:r(()=>[(k(!0),A(se,null,ie(v.value,t=>(k(),R(H,{key:String(t.id),label:t.name,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),n(V,{label:"员工人数",prop:"employeeCount"},{default:r(()=>[n(o,{modelValue:s.value.employeeCount,"onUpdate:modelValue":e[3]||(e[3]=t=>s.value.employeeCount=t),placeholder:"员工人数",disabled:""},null,8,["modelValue"])]),_:1}),n(V,{label:"部门描述",prop:"description"},{default:r(()=>[n(o,{modelValue:s.value.description,"onUpdate:modelValue":e[4]||(e[4]=t=>s.value.description=t),placeholder:"请输入部门描述",type:"textarea",rows:"3",maxlength:"200"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},De=de(_e,[["__scopeId","data-v-03aec9a1"]]);export{De as default};
