import{a as x}from"./index-Dv0iaADD.js";import{_ as ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as f,a as E,o as le,c as N,b as m,d as l,w as n,f as c,E as p,G as te,g as U,H as oe,h,C as B,t as ne,e as se,n as re}from"./index-BFadyM4N.js";const de={class:"user-management"},ue={class:"card-header"},ie={class:"search-bar"},me={class:"search-container"},pe={class:"form-grid"},ce={class:"form-column"},ge={class:"form-column"},fe={class:"form-row"},ve={class:"button-group"},_e={key:1},be={class:"pagination"},he={class:"dialog-footer"},we={__name:"UserManagement",setup(Ve){const C=f(""),d=E({username:"",name:"",phone:"",email:"",role:""}),y=f(1),S=f(10),_=f(0),r=f([]),z=f(!1),V=f(!1),b=f("add"),I=f(""),q=f(!1),k=f(null),t=E({id:"",username:"",name:"",password:"",phone:"",email:"",role:1,status:!0}),R={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度应在3-20个字符之间",trigger:"blur"}],name:[{required:!0,message:"请输入真实姓名",trigger:"blur"},{min:2,max:20,message:"姓名长度应在2-20个字符之间",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],role:[{required:!0,message:"请选择角色",trigger:"change"}]},A=e=>e&&(typeof e.status=="string"?e.status=e.status==="active"||e.status==="1"||e.status==="true":e.status===void 0&&(e.status=!0),e),w=async()=>{z.value=!0;try{const e=await x.admin.getUserList({page:y.value,pageSize:S.value,username:d.username||C.value,phone:d.phone||C.value,email:d.email||C.value,name:d.name,role:d.role});if(console.log("API响应:",e),r.value=[],_.value=0,!e){console.warn("API响应为空");return}e.code&&(e.code===1||e.code===200)||!e.code?(Array.isArray(e)?(r.value=e.map(A),_.value=e.length):Array.isArray(e.data)?(r.value=e.data.map(A),_.value=e.total||e.count||e.data.length):e.data&&e.data.items?(r.value=(e.data.items||[]).map(A),_.value=e.data.total||0):e.data&&e.data.rows?(console.log("处理API返回的标准分页格式数据"),r.value=(e.data.rows||[]).map(A),_.value=e.data.total||0):(console.warn("无法识别的API响应格式，使用模拟数据"),r.value=[{id:1,username:"admin",name:"系统管理员",role:0,gender:"男",age:35,phone:"13800138000",email:"admin@healthplatform.com",health_record_number:"ADMIN0001",status:!0,createdAt:new Date().toLocaleString()},{id:2,username:"zhangsan",name:"张三",role:1,gender:"男",age:65,phone:"13800138001",email:"zhangsan@example.com",health_record_number:"HR20240001",status:!0,createdAt:new Date().toLocaleString()},{id:3,username:"lisi",name:"李四",role:1,gender:"女",age:68,phone:"13800138002",email:"lisi@example.com",health_record_number:"HR20240002",status:!0,createdAt:new Date().toLocaleString()}],_.value=r.value.length),console.log("成功获取用户数据:",r.value)):p.error(e.msg||"获取用户列表失败")}catch(e){console.error("加载用户数据失败",e),p.error("加载数据失败，请重试"),r.value=[{id:1,username:"admin",name:"系统管理员",role:0,gender:"男",age:35,phone:"13800138000",email:"admin@healthplatform.com",health_record_number:"ADMIN0001",status:!0,createdAt:new Date().toLocaleString()},{id:2,username:"zhangsan",name:"张三",role:1,gender:"男",age:65,phone:"13800138001",email:"zhangsan@example.com",health_record_number:"HR20240001",status:!0,createdAt:new Date().toLocaleString()}],_.value=r.value.length}finally{z.value=!1}},P=()=>{y.value=1,w()},T=()=>{Object.keys(d).forEach(e=>{d[e]=""}),C.value="",y.value=1,w()},H=()=>{b.value="add",I.value="添加用户",j(),V.value=!0},F=e=>{b.value="edit",I.value="编辑用户",t.id=e.id,t.username=e.username,t.name=e.name,t.phone=e.phone,t.email=e.email,t.role=e.role,t.status=e.status,t.password="",V.value=!0},j=()=>{k.value&&k.value.resetFields(),t.id="",t.username="",t.name="",t.password="",t.phone="",t.email="",t.role=1,t.status=!0},G=async()=>{await k.value.validate(async e=>{if(e){q.value=!0;try{let a;if(b.value==="add")a=await x.user.addUser({username:t.username,name:t.name,password:t.password,phone:t.phone,email:t.email,role:t.role,status:t.status});else{const u={id:t.id,name:t.name,phone:t.phone,email:t.email,role:t.role,status:t.status};t.password&&(u.password=t.password),a=await x.user.updateUser(u)}a.code===1?(p.success(b.value==="add"?"添加用户成功":"编辑用户成功"),V.value=!1,w()):p.error(a.msg||(b.value==="add"?"添加用户失败":"编辑用户失败"))}catch(a){console.error(b.value==="add"?"添加用户失败":"编辑用户失败",a),p.error("操作失败，请重试")}finally{q.value=!1}}})},O=e=>{if(e.role===0){p.warning("不允许删除管理员账户");return}re.confirm(`确定要删除用户「${e.username}」吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const a=await x.user.deleteUser(e.id);a.code===1?(p.success("删除成功"),w()):p.error(a.msg||"删除失败")}catch(a){console.error("删除用户失败",a),p.error("删除失败，请重试")}}).catch(()=>{})},Q=async(e,a)=>{try{if(!e||!e.id){console.warn("无效的用户对象");return}const u=a!==void 0?a:e.status;if(e.role===0&&!u){p.warning("不允许禁用管理员账户");const s=r.value.findIndex(g=>g.id===e.id);s!==-1&&(r.value[s].status=!0);return}const i=await x.user.updateUser({id:e.id,status:u});if(i&&i.code===1){p.success(`用户状态已${u?"启用":"禁用"}`);const s=r.value.findIndex(g=>g.id===e.id);s!==-1&&(r.value[s].status=u)}else{const s=r.value.findIndex(g=>g.id===e.id);s!==-1&&(r.value[s].status=!u),p.error(i&&i.msg||"更新状态失败")}}catch(u){console.error("更新用户状态失败",u);const i=r.value.findIndex(s=>s.id===e.id);i!==-1&&(r.value[i].status=!e.status),p.error("操作失败，请重试")}},J=e=>{S.value=e,w()},K=e=>{y.value=e,w()};return le(()=>{w()}),(e,a)=>{const u=c("el-button"),i=c("el-input"),s=c("el-form-item"),g=c("el-option"),L=c("el-select"),M=c("el-form"),v=c("el-table-column"),$=c("el-switch"),W=c("el-table"),X=c("el-pagination"),Y=c("el-card"),Z=c("el-dialog"),ee=te("loading");return U(),N("div",de,[a[22]||(a[22]=m("div",{class:"page-header"},[m("h2",null,"用户信息管理"),m("p",null,"管理系统中的所有用户信息")],-1)),l(Y,{class:"content-card"},{header:n(()=>[m("div",ue,[a[15]||(a[15]=m("span",null,"用户列表",-1)),l(u,{type:"primary",onClick:H},{default:n(()=>[...a[14]||(a[14]=[h("添加用户",-1)])]),_:1})])]),default:n(()=>[m("div",ie,[m("div",me,[l(M,{inline:!1,model:d,class:"demo-form","label-width":"80px"},{default:n(()=>[m("div",pe,[m("div",ce,[l(s,{label:"用户名"},{default:n(()=>[l(i,{modelValue:d.username,"onUpdate:modelValue":a[0]||(a[0]=o=>d.username=o),placeholder:"请输入用户名",clearable:""},null,8,["modelValue"])]),_:1}),l(s,{label:"真实姓名"},{default:n(()=>[l(i,{modelValue:d.name,"onUpdate:modelValue":a[1]||(a[1]=o=>d.name=o),placeholder:"请输入真实姓名",clearable:""},null,8,["modelValue"])]),_:1})]),m("div",ge,[l(s,{label:"手机号"},{default:n(()=>[l(i,{modelValue:d.phone,"onUpdate:modelValue":a[2]||(a[2]=o=>d.phone=o),placeholder:"请输入手机号",clearable:""},null,8,["modelValue"])]),_:1}),l(s,{label:"邮箱"},{default:n(()=>[l(i,{modelValue:d.email,"onUpdate:modelValue":a[3]||(a[3]=o=>d.email=o),placeholder:"请输入邮箱",clearable:""},null,8,["modelValue"])]),_:1})])]),m("div",fe,[l(s,{label:"用户角色",class:"role-item"},{default:n(()=>[l(L,{modelValue:d.role,"onUpdate:modelValue":a[4]||(a[4]=o=>d.role=o),placeholder:"请选择角色",clearable:""},{default:n(()=>[l(g,{label:"全部",value:""}),l(g,{label:"普通用户",value:"1"}),l(g,{label:"管理员",value:"0"})]),_:1},8,["modelValue"])]),_:1}),l(s,{class:"button-item"},{default:n(()=>[m("div",ve,[l(u,{type:"primary",onClick:P,class:"search-btn"},{default:n(()=>[...a[16]||(a[16]=[m("i",{class:"el-icon-search"},null,-1),h(" 搜索 ",-1)])]),_:1}),l(u,{onClick:T,class:"reset-btn"},{default:n(()=>[...a[17]||(a[17]=[m("i",{class:"el-icon-refresh"},null,-1),h(" 重置 ",-1)])]),_:1})])]),_:1})])]),_:1},8,["model"])])]),oe((U(),B(W,{data:r.value,style:{width:"100%"}},{default:n(()=>[l(v,{prop:"id",label:"用户ID",width:"80"}),l(v,{prop:"username",label:"用户名"}),l(v,{prop:"name",label:"真实姓名"}),l(v,{prop:"phone",label:"手机号"}),l(v,{prop:"email",label:"邮箱"}),l(v,{prop:"role",label:"角色"},{default:n(o=>[h(ne(o.row?.role===0?"管理员":"普通用户"),1)]),_:1}),l(v,{prop:"createdAt",label:"创建时间"}),l(v,{prop:"status",label:"状态"},{default:n(o=>[o.row&&o.row.id?(U(),B($,{key:0,modelValue:o.row.status,"onUpdate:modelValue":D=>o.row.status=D,"active-value":!0,"inactive-value":!1,"active-text":"启用","inactive-text":"禁用",onChange:D=>Q(o.row,o.row.status)},null,8,["modelValue","onUpdate:modelValue","onChange"])):(U(),N("span",_e,"--"))]),_:1}),l(v,{label:"操作",width:"150"},{default:n(o=>[l(u,{size:"small",onClick:D=>F(o.row)},{default:n(()=>[...a[18]||(a[18]=[h("编辑",-1)])]),_:1},8,["onClick"]),l(u,{size:"small",type:"danger",onClick:D=>O(o.row)},{default:n(()=>[...a[19]||(a[19]=[h("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ee,z.value]]),m("div",be,[l(X,{"current-page":y.value,"page-size":S.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:_.value,onSizeChange:J,onCurrentChange:K},null,8,["current-page","page-size","total"])])]),_:1}),l(Z,{modelValue:V.value,"onUpdate:modelValue":a[13]||(a[13]=o=>V.value=o),title:I.value,width:"500px","close-on-click-modal":!1},{footer:n(()=>[m("span",he,[l(u,{onClick:a[12]||(a[12]=o=>V.value=!1)},{default:n(()=>[...a[20]||(a[20]=[h("取消",-1)])]),_:1}),l(u,{type:"primary",onClick:G,loading:q.value},{default:n(()=>[...a[21]||(a[21]=[h("确认",-1)])]),_:1},8,["loading"])])]),default:n(()=>[l(M,{model:t,rules:R,ref_key:"formRef",ref:k,"label-width":"100px"},{default:n(()=>[l(s,{label:"用户名",prop:"username"},{default:n(()=>[l(i,{modelValue:t.username,"onUpdate:modelValue":a[5]||(a[5]=o=>t.username=o),disabled:b.value==="edit"},null,8,["modelValue","disabled"])]),_:1}),l(s,{label:"真实姓名",prop:"name"},{default:n(()=>[l(i,{modelValue:t.name,"onUpdate:modelValue":a[6]||(a[6]=o=>t.name=o)},null,8,["modelValue"])]),_:1}),b.value==="add"?(U(),B(s,{key:0,label:"密码",prop:"password"},{default:n(()=>[l(i,{modelValue:t.password,"onUpdate:modelValue":a[7]||(a[7]=o=>t.password=o),type:"password"},null,8,["modelValue"])]),_:1})):se("",!0),l(s,{label:"手机号",prop:"phone"},{default:n(()=>[l(i,{modelValue:t.phone,"onUpdate:modelValue":a[8]||(a[8]=o=>t.phone=o)},null,8,["modelValue"])]),_:1}),l(s,{label:"邮箱",prop:"email"},{default:n(()=>[l(i,{modelValue:t.email,"onUpdate:modelValue":a[9]||(a[9]=o=>t.email=o)},null,8,["modelValue"])]),_:1}),l(s,{label:"角色",prop:"role"},{default:n(()=>[l(L,{modelValue:t.role,"onUpdate:modelValue":a[10]||(a[10]=o=>t.role=o),placeholder:"请选择角色"},{default:n(()=>[l(g,{label:"普通用户",value:1}),l(g,{label:"管理员",value:0})]),_:1},8,["modelValue"])]),_:1}),l(s,{label:"状态",prop:"status"},{default:n(()=>[l($,{modelValue:t.status,"onUpdate:modelValue":a[11]||(a[11]=o=>t.status=o),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Ce=ae(we,[["__scopeId","data-v-4f6a03cc"]]);export{Ce as default};
